{% extends 'base.html' %}

{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mes-objectifs.css') }}">
<div class="content-container">

    <h1 class="page-title">Mes Objectifs</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message {{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" class="objectif-form">
        <h2>Ajouter un objectif</h2>

        <div class="form-row">
            <label>Montant cible (‚Ç¨)</label>
            <input type="number" name="montant" placeholder="Ex: 500.00" min="0" step="0.01" required>
        </div>

        <div class="form-row">
            <label>Description</label>
            <input type="text" name="description" placeholder="Ex: √âconomies vacances">
        </div>

        <div class="form-row">
            <label>Fr√©quence</label>
            <select name="frequence">
                <option value="mensuel">Mensuel</option>
                <option value="annuel">Annuel</option>
            </select>
        </div>

        <div class="form-row">
            <label>Cat√©gorie</label>
            <select name="categorie" required>
                {% for cat in categories %}
                    <option value="{{ cat.idCategorie }}">{{ cat.nom }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn-submit">Ajouter</button>
    </form>

    <h2>Objectifs actuels</h2>

    {% if objectifs_status %}
        <div class="objectifs-list">
            {% for obj, epargne, montant_cible, pourcentage, status in objectifs_status %}
                {% set pourcentage_affiche = [pourcentage, 100]|min %}
                <div class="objectif-card" id="objectif-{{ obj.idObjectif }}">
                    <div class="objectif-content">
                        <div class="objectif-header">
                            <div class="objectif-left">
                                <h1 class="objectif-title">{{ obj.description or "Sans titre" }}</h1>
                                <span class="categorie-label">{{ obj.categorie.nom }} ¬∑ {{ obj.frequence }}</span>
                            </div>
                            <div class="objectif-right">
                                <div class="objectif-stats">
                                    <span class="montant-actuel {% if status == 'Atteint' %}atteint{% else %}encours{% endif %}">
                                        {{ "%.2f"|format(epargne) }} / {{ "%.2f"|format(montant_cible) }} ‚Ç¨
                                    </span>
                                </div>
                                <span class="status-badge {% if status == 'Atteint' %}atteint{% else %}encours{% endif %}">
                                    {{ status }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill {% if status == 'Atteint' %}atteint{% else %}encours{% endif %}" 
                                     style="width: {{ pourcentage_affiche }}%">
                                </div>
                            </div>
                            <span class="progress-percent {% if status == 'Atteint' %}atteint{% else %}encours{% endif %}">
                                {{ "%.0f"|format(pourcentage) }}%
                            </span>
                        </div>

                        <div class="objectif-actions-bar">
                            <div class="epargne-controls">
                                <form action="{{ url_for('retirer_epargne', id=obj.idObjectif) }}" method="POST" class="epargne-form-group">
                                    <input type="hidden" name="montant" id="montant-retirer-{{ obj.idObjectif }}" value="10">
                                    <button type="submit" class="btn-epargne btn-moins" title="Retirer">
                                        <span>‚àí</span>
                                    </button>
                                </form>
                                
                                <div class="montant-input-group">
                                    <input type="number" id="montant-input-{{ obj.idObjectif }}" placeholder="Montant" min="0.01" step="0.01" class="input-montant" 
                                           onchange="document.getElementById('montant-ajouter-{{ obj.idObjectif }}').value = this.value; document.getElementById('montant-retirer-{{ obj.idObjectif }}').value = this.value;">
                                </div>

                                <form action="{{ url_for('ajouter_epargne', id=obj.idObjectif) }}" method="POST" class="epargne-form-group">
                                    <input type="hidden" name="montant" id="montant-ajouter-{{ obj.idObjectif }}" value="10">
                                    <button type="submit" class="btn-epargne btn-plus-custom" title="Ajouter">
                                        <span>+</span>
                                    </button>
                                </form>
                                
                                <form action="{{ url_for('ajouter_epargne', id=obj.idObjectif) }}" method="POST" class="epargne-form-group">
                                    <input type="hidden" name="montant" value="10">
                                    <button type="submit" class="btn-epargne btn-plus-10" title="Ajouter 10‚Ç¨">
                                        <span>+10‚Ç¨</span>
                                    </button>
                                </form>
                            </div>
                            
                            <form action="{{ url_for('supprimer_objectif', id=obj.idObjectif) }}" method="POST" class="delete-form">
                                <button type="submit" class="btn-delete" title="Supprimer l'objectif" onclick="return confirm('Supprimer cet objectif ?')">
                                    üóëÔ∏è
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="no-objectifs">Aucun objectif d√©fini pour le moment.</p>
    {% endif %}
</div>
{% endblock %}
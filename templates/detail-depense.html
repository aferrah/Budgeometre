{% extends "base.html" %}

{% block title %}Dépenses - {{ categorie.nom }} - Budgeomètre{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/detail-depense.css') }}">
{% endblock %}

{% block header_content %}
    <h1>Dépenses - {{ categorie.nom }} </h1>
{% endblock %}

{% block content %}
<main class="depenses-cat-page">

    <div class="page-header">
        <h2>Dépenses : {{ categorie.nom }}</h2>
        <a href="{{ url_for('dashboard.budget_dashboard') }}" class="btn-back">← Retour au dashboard</a>
    </div>

    <div class="total-card" style="border-left: 4px solid {{ categorie.couleur or '#8b5cf6' }};">
        <div class="label">Total des dépenses dans cette catégorie</div>
        <div class="value" style="color: {{ categorie.couleur or '#8b5cf6' }};">{{ '%.2f'|format(total_depenses) }} €</div>
    </div>

    <div class="period-selector">
        <button class="period-btn active" onclick="showChart('mois', this)">Par mois</button>
        <button class="period-btn" onclick="showChart('trimestre', this)">Par trimestre</button>
        <button class="period-btn" onclick="showChart('annee', this)">Par année</button>
    </div>

    <div class="chart-container">
        <h3 id="chart-title">Évolution mensuelle</h3>
        <div class="chart-wrapper">
            <canvas id="depensesChart"></canvas>
        </div>
    </div>

    <div class="transactions-section">
        <h3>Dernières transactions</h3>
        {% if transactions %}
            {% for t in transactions %}
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-titre">{{ t.titre }}</div>
                        <div class="transaction-date">{{ t.dateTransaction.strftime('%d/%m/%Y') }}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="transaction-montant">{{ '%.2f'|format(t.montant) }} €</div>
                        <div class="transaction-actions">
                            <a href="{{ url_for('transactions.modifier_transaction', id=t.idTransaction) }}" class="btn-edit" title="Modifier">
                                <img src="{{ url_for('static', filename='widget/widget_pencil.png') }}" alt="Modifier" class="btn-edit-icon">
                            </a>
                            <button class="btn-delete" onclick="confirmDelete({{ t.idTransaction }}, '{{ t.titre }}')" title="Supprimer">
                                <img src="{{ url_for('static', filename='widget/widget_trash_can.png') }}" alt="Supprimer" class="btn-delete-icon">
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="no-data">Aucune transaction dans cette catégorie</div>
        {% endif %}
    </div>

</main>
{% endblock %}

{% block scripts %}
<script>
    // Données depuis Flask
    const moisLabels = {{ mois_labels | tojson }};
    const moisData = {{ mois_data | tojson }};
    const trimestreLabels = {{ trimestre_labels | tojson }};
    const trimestreData = {{ trimestre_data | tojson }};
    const anneeLabels = {{ annee_labels | tojson }};
    const anneeData = {{ annee_data | tojson }};
    const categorieCouleur = {{ (categorie.couleur or '#8b5cf6') | tojson }};

    let currentChart = null;

    function createChart(labels, data, label) {
        const ctx = document.getElementById('depensesChart').getContext('2d');

        if (currentChart) {
            currentChart.destroy();
        }

        currentChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: categorieCouleur + 'B3',
                    borderColor: categorieCouleur,
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#fff',
                            callback: function(value) {
                                return value + ' €';
                            }
                        },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    x: {
                        ticks: { color: '#fff' },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    function showChart(period, btn) {
        // Mettre à jour les boutons
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const titleEl = document.getElementById('chart-title');

        if (period === 'mois') {
            titleEl.textContent = 'Évolution mensuelle';
            createChart(moisLabels, moisData, 'Dépenses par mois');
        } else if (period === 'trimestre') {
            titleEl.textContent = 'Évolution trimestrielle';
            createChart(trimestreLabels, trimestreData, 'Dépenses par trimestre');
        } else if (period === 'annee') {
            titleEl.textContent = 'Évolution annuelle';
            createChart(anneeLabels, anneeData, 'Dépenses par année');
        }
    }

    // Initialiser avec le graphique mensuel
    window.addEventListener('load', () => {
        createChart(moisLabels, moisData, 'Dépenses par mois');
    });

    // Fonction de confirmation de suppression
    function confirmDelete(transactionId, transactionTitre) {
        if (confirm(`Êtes-vous sûr de vouloir supprimer la transaction "${transactionTitre}" ?\n\nCette action est irréversible.`)) {
            // Créer un formulaire et le soumettre
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/transaction/${transactionId}/supprimer`;
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}
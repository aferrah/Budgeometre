{% extends "base.html" %}

{% block title %}Budgeomètre - Accueil{% endblock %}

{% block head_extra %}
<style>
    .solde-card {
        text-align: center;
        padding: 30px;
    }

    .solde-circle-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto 20px;
    }

    .solde-circle {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 160px;
        height: 160px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 2;
    }

    .progress-ring {
        transform: rotate(-90deg);
        position: absolute;
        top: 0;
        left: 0;
    }

    .progress-ring-circle {
        transition: stroke-dashoffset 0.8s ease;
        transform-origin: 50% 50%;
    }

    /* Couleurs basées sur le niveau du solde */
    .solde-circle.excellent {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.1);
    }

    .solde-circle.bon {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
    }

    .solde-circle.moyen {
        border-color: #eab308;
        background: rgba(234, 179, 8, 0.1);
    }

    .solde-circle.faible {
        border-color: #f97316;
        background: rgba(249, 115, 22, 0.1);
    }

    .solde-circle.critique {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }

    .solde-circle .montant {
        font-size: 1.8rem;
        font-weight: 700;
    }

    .solde-circle.excellent .montant {
        color: #10b981;
    }

    .solde-circle.bon .montant {
        color: #22c55e;
    }

    .solde-circle.moyen .montant {
        color: #eab308;
    }

    .solde-circle.faible .montant {
        color: #f97316;
    }

    .solde-circle.critique .montant {
        color: #ef4444;
    }

    .solde-circle .label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .stats-row {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .stat-item {
        text-align: center;
    }

    .stat-item .value {
        font-size: 1.3rem;
        font-weight: 700;
    }

    .stat-item .value.revenus {
        color: #10b981;
    }

    .stat-item .value.depenses {
        color: #ef4444;
    }

    .stat-item .label {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
    }

    .recent-expenses h2 {
        margin-bottom: 15px;
        color: white;
    }

    .recent-expenses table {
        width: 100%;
        border-collapse: collapse;
    }

    .recent-expenses th,
    .recent-expenses td {
        padding: 12px 15px;
        text-align: left;
    }

    .recent-expenses th {
        color: rgba(255, 255, 255, 0.7);
        font-weight: 600;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .recent-expenses td {
        color: white;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .recent-expenses tr:last-child td {
        border-bottom: none;
    }

    .montant-cell.positif {
        color: #10b981;
    }

    .montant-cell.negatif {
        color: #ef4444;
    }

    .sortable:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .sort-icon {
        font-size: 0.8rem;
        opacity: 0.5;
        margin-left: 5px;
    }

    .sortable.active-sort .sort-icon {
        opacity: 1;
    }

    input[type="text"]::placeholder,
    select option {
        color: rgba(255, 255, 255, 0.5);
    }

    select option {
        background: #1f2937;
        color: white;
    }

    #resetBtn:hover {
        background: rgba(255, 255, 255, 0.25);
    }
</style>
{% endblock %}

{% block content %}
    <!-- Carte solde principal -->
    <div class="solde-card glass-card" style="margin-bottom: 20px;">
        {% set ratio = (argentActuel / total_revenus * 100) if total_revenus > 0 else 0 %}
        {% set ratio_capped = [ratio, 100]|min if ratio >= 0 else 0 %}
        {% if ratio >= 75 %}
            {% set niveau = 'excellent' %}
            {% set color = '#10b981' %}
        {% elif ratio >= 50 %}
            {% set niveau = 'bon' %}
            {% set color = '#22c55e' %}
        {% elif ratio >= 25 %}
            {% set niveau = 'moyen' %}
            {% set color = '#eab308' %}
        {% elif ratio >= 0 %}
            {% set niveau = 'faible' %}
            {% set color = '#f97316' %}
        {% else %}
            {% set niveau = 'critique' %}
            {% set color = '#ef4444' %}
        {% endif %}
        <div class="solde-circle-container">
            <svg class="progress-ring" width="200" height="200">
                <!-- Cercle de fond -->
                <circle
                    cx="100"
                    cy="100"
                    r="90"
                    stroke="rgba(255, 255, 255, 0.1)"
                    stroke-width="12"
                    fill="none"
                />
                <!-- Cercle de progression -->
                <circle
                    class="progress-ring-circle"
                    cx="100"
                    cy="100"
                    r="90"
                    stroke="{{ color }}"
                    stroke-width="12"
                    fill="none"
                    stroke-dasharray="565.48"
                    stroke-dashoffset="{{ 565.48 - (565.48 * ratio_capped / 100) }}"
                    stroke-linecap="round"
                />
            </svg>
            <div class="solde-circle {{ niveau }}">
                <span class="montant">{{ '%.2f'|format(argentActuel) }} €</span>
                <span class="label">{{ '%.0f'|format(ratio_capped) }}% des revenus restants</span>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-item">
                <div class="value revenus">+{{ '%.2f'|format(total_revenus) }} €</div>
                <div class="label">Revenus</div>
            </div>
            <div class="stat-item">
                <div class="value depenses">-{{ '%.2f'|format(total_depenses) }} €</div>
                <div class="label">Dépenses</div>
            </div>
        </div>
    </div>

    <!-- Bouton ajouter -->
    <div class="add-expense-container" style="margin-bottom: 30px;">
        <a class="add-expense-btn" href="{{ url_for('add_expense') }}">Ajouter une transaction</a>
    </div>

    <!-- Dernières transactions -->
    <section class="recent-expenses glass-card" style="margin-bottom: 20px;">
        <h2>Transactions</h2>
        
        {% if transactions %}
            <!-- Filtres -->
            <div class="filters-container" style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                <div class="filter-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.7); font-size: 0.85rem;"> Recherche</label>
                    <input type="text" id="searchInput" placeholder="Rechercher..." 
                           style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
                </div>
                
                <div class="filter-group" style="flex: 0 0 auto; min-width: 150px;">
                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.7); font-size: 0.85rem;">Catégorie</label>
                    <select id="categoryFilter" 
                            style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
                        <option value="all">Toutes</option>
                        {% set categories_set = [] %}
                        {% for t in transactions %}
                            {% if t.categorie.nom not in categories_set %}
                                {% set _ = categories_set.append(t.categorie.nom) %}
                                <option value="{{ t.idCategorie }}">{{ t.categorie.nom }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group" style="flex: 0 0 auto; min-width: 130px;">
                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.7); font-size: 0.85rem;">Type</label>
                    <select id="typeFilter" 
                            style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
                        <option value="all">Tout</option>
                        <option value="revenus">Revenus</option>
                        <option value="depenses">Dépenses</option>
                    </select>
                </div>
                
                <button id="resetBtn" 
                        style="padding: 8px 16px; border-radius: 6px; border: none; background: rgba(255,255,255,0.15); color: white; cursor: pointer; font-size: 0.9rem;">
                    Réinitialiser
                </button>
            </div>

            <table id="transactionsTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="date" style="cursor: pointer; user-select: none;">
                            Date <span class="sort-icon">⇅</span>
                        </th>
                        <th class="sortable" data-column="titre" style="cursor: pointer; user-select: none;">
                            Libellé <span class="sort-icon">⇅</span>
                        </th>
                        <th class="sortable" data-column="categorie" style="cursor: pointer; user-select: none;">
                            Catégorie <span class="sort-icon">⇅</span>
                        </th>
                        <th class="sortable" data-column="montant" style="cursor: pointer; user-select: none;">
                            Montant <span class="sort-icon">⇅</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="transactionsBody">
                    {% for t in transactions %}
                        <tr class="transaction-row"
                            data-date="{{ t.dateTransaction.timestamp() }}"
                            data-titre="{{ t.titre|lower }}"
                            data-categorie="{{ t.idCategorie }}"
                            data-montant="{{ t.montant }}">
                            <td>{{ t.dateTransaction.strftime('%d/%m/%Y') }}</td>
                            <td>{{ t.titre }}</td>
                            <td>
                                <span style="display: inline-block; padding: 3px 10px; border-radius: 12px; background: rgba(255,255,255,0.15); font-size: 0.85rem;">
                                    {{ t.categorie.nom }}
                                </span>
                            </td>
                            <td class="montant-cell {{ 'positif' if t.montant >= 0 else 'negatif' }}">
                                {{ '+' if t.montant >= 0 else '' }}{{ '%.2f'|format(t.montant) }} €
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div id="noResults" style="display: none; text-align: center; padding: 30px; color: rgba(255,255,255,0.6);">
                Aucune transaction trouvée avec ces critères.
            </div>

        {% else %}
            <p style="color: rgba(255, 255, 255, 0.7); text-align: center; padding: 20px;">
                Aucune transaction enregistrée pour l'instant.
            </p>
        {% endif %}
    </section>

    <!-- Lien vers dashboard -->
    <div class="add-expense-container">
        <a href="{{ url_for('budget_dashboard') }}" style="opacity: 0.8;">Accéder au dashboard</a>
    </div>

    <script>
        // Variables globales
        let currentSort = { column: 'date', direction: 'desc' };
        let allRows = [];

        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', function() {
            const tbody = document.getElementById('transactionsBody');
            if (tbody) {
                allRows = Array.from(tbody.querySelectorAll('.transaction-row'));
                attachEventListeners();
                
                // Tri initial par date décroissante
                sortTable('date');
            }
        });

        // Attacher les écouteurs
        function attachEventListeners() {
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    sortTable(this.dataset.column);
                });
            });

            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);
            document.getElementById('typeFilter').addEventListener('change', applyFilters);
            document.getElementById('resetBtn').addEventListener('click', resetFilters);
        }

        // Fonction de tri
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            const visibleRows = allRows.filter(row => row.style.display !== 'none');
            
            visibleRows.sort((a, b) => {
                let aValue, bValue;

                switch(column) {
                    case 'date':
                        aValue = parseFloat(a.dataset.date);
                        bValue = parseFloat(b.dataset.date);
                        break;
                    case 'titre':
                        aValue = a.dataset.titre;
                        bValue = b.dataset.titre;
                        break;
                    case 'categorie':
                        aValue = a.cells[2].textContent.trim();
                        bValue = b.cells[2].textContent.trim();
                        break;
                    case 'montant':
                        aValue = parseFloat(a.dataset.montant);
                        bValue = parseFloat(b.dataset.montant);
                        break;
                    default:
                        return 0;
                }

                let result = 0;
                if (typeof aValue === 'string') {
                    result = aValue.localeCompare(bValue, 'fr');
                } else {
                    result = aValue - bValue;
                }

                return currentSort.direction === 'asc' ? result : -result;
            });

            const tbody = document.getElementById('transactionsBody');
            visibleRows.forEach(row => tbody.appendChild(row));

            updateSortIcons();
        }

        // Mettre à jour les icônes
        function updateSortIcons() {
            document.querySelectorAll('.sortable').forEach(header => {
                const icon = header.querySelector('.sort-icon');
                const column = header.dataset.column;
                
                if (column === currentSort.column) {
                    icon.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
                    header.classList.add('active-sort');
                } else {
                    icon.textContent = '⇅';
                    header.classList.remove('active-sort');
                }
            });
        }

        // Appliquer les filtres
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            let visibleCount = 0;

            allRows.forEach(row => {
                const titre = row.dataset.titre;
                const categorie = row.dataset.categorie;
                const montant = parseFloat(row.dataset.montant);

                let show = true;

                if (searchTerm && !titre.includes(searchTerm)) {
                    show = false;
                }

                if (categoryFilter !== 'all' && categorie !== categoryFilter) {
                    show = false;
                }

                if (typeFilter === 'revenus' && montant <= 0) {
                    show = false;
                } else if (typeFilter === 'depenses' && montant >= 0) {
                    show = false;
                }

                row.style.display = show ? '' : 'none';
                if (show) visibleCount++;
            });

            const noResults = document.getElementById('noResults');
            const table = document.getElementById('transactionsTable');
            if (visibleCount === 0) {
                noResults.style.display = 'block';
                table.style.display = 'none';
            } else {
                noResults.style.display = 'none';
                table.style.display = 'table';
            }
        }

        // Réinitialiser
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
            
            allRows.forEach(row => row.style.display = '');
            
            currentSort = { column: 'date', direction: 'desc' };
            sortTable('date');
        }
    </script>
{% endblock %}
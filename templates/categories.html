{% extends "base.html" %}

{% block title %}Cat√©gories - Budgeom√®tre{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/categories.css') }}">
{% endblock %}

{% block header_content %}
    <h1>Cat√©gories des d√©penses</h1>
{% endblock %}

{% block content %}
<main class="categories-page">
    <div style="margin-bottom: 50px;">
    <a href="{{ url_for('home') }}" class="btn-back">‚Üê Retour √† l'accueil</a>
    </div>
    <!-- Messages flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="categories-header">
        <h2>Cat√©gories</h2>
    </div>

    <!-- Formulaire d'ajout -->
    <div class="add-category-form glass-card">
        <h3> Ajouter une cat√©gorie</h3>
        <form method="post" action="{{ url_for('categories') }}">
            <div class="form-row">
                <input type="text" name="nom" placeholder="Nom de la cat√©gorie" required>
                <input type="text" name="description" placeholder="Description (optionnel)">
                <input type="color" name="couleur" value="#8b5cf6" title="Couleur de la cat√©gorie">
            </div>
            <div class="form-row" style="margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 10px; color: white; cursor: pointer; flex: 0 0 auto; margin-right: 16px;">
                    <input type="checkbox" id="has_limit" onchange="toggleLimitInput()" style="width: 20px; height: 20px; cursor: pointer;">
                    <span style="white-space: nowrap;">D√©finir une limite de budget mensuel</span>
                </label>
                <input type="number" id="limite_budget_input" name="limite_budget" placeholder="Limite budget (‚Ç¨)" min="0" step="0.01" style="display: none;">
                <button type="submit" class="btn-add" title="Ajouter la cat√©gorie">+</button>
            </div>
        </form>
    </div>

    <!-- Liste des cat√©gories -->
    <div class="categories-list">
        {% if categories %}
            {% for cat in categories %}
                <div class="category-card" style="border-left-color: {{ cat.couleur or '#8b5cf6' }};">
                    <div class="category-header">
                        <div class="category-info">
                            <div class="category-name">
                                {{ cat.nom }}
                            </div>
                            <div class="category-description">{{ cat.description or 'Aucune description' }}</div>
                        </div>
                        <div class="category-stats">
                            <div class="count">{{ cat.transactions|length }}</div>
                            <div class="label">transaction(s)</div>
                        </div>
                        <div class="category-actions">
                            <button type="button" class="btn-toggle" onclick="toggleTransactions(this, 'transactions-{{ cat.idCategorie }}')">
                                ‚ñº Voir
                            </button>
                            <form method="post" action="{{ url_for('delete_category', id=cat.idCategorie) }}" style="display:inline;">
                                <button type="submit" class="btn-delete" onclick="return confirm('Supprimer cette cat√©gorie ?')">üóëÔ∏è</button>
                            </form>
                        </div>
                    </div>

                    <!-- Section Budget (si limite d√©finie) -->
                    {% if cat.limite_budget and cat.limite_budget > 0 %}
                    <div class="category-budget-section">
                        <div class="budget-info">
                            <span class="budget-label">Budget mensuel:</span>
                            <div class="budget-bar-container">
                                {% set pct = cat.pourcentage|default(0) %}
                                {% if pct < 80 %}
                                    {% set bar_class = 'ok' %}
                                {% elif pct < 100 %}
                                    {% set bar_class = 'warning' %}
                                {% else %}
                                    {% set bar_class = 'danger' %}
                                {% endif %}
                                <div class="budget-bar {{ bar_class }}" style="width: {{ [pct, 100]|min }}%;"></div>
                            </div>
                            <div class="budget-amounts">
                                <span class="budget-spent">{{ '%.2f'|format(cat.depenses_mois|default(0)) }}‚Ç¨</span>
                                <span class="budget-limit">/ {{ '%.2f'|format(cat.limite_budget) }}‚Ç¨</span>
                            </div>
                        </div>
                        {% if pct >= 80 and pct < 100 %}
                            <div class="budget-alert warning">
                                ‚ö†Ô∏è Attention : vous avez utilis√© {{ '%.0f'|format(pct) }}% de votre budget
                            </div>
                        {% elif pct >= 100 %}
                            <div class="budget-alert danger">
                                ‚ö†Ô∏è Budget d√©pass√© de {{ '%.2f'|format(cat.depenses_mois - cat.limite_budget|float) }}‚Ç¨ !
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- D√©roulant des 3 derni√®res transactions -->
                    <div class="transactions-dropdown" id="transactions-{{ cat.idCategorie }}">
                        <div class="transactions-list">
                            {% set derniers_transactions = cat.transactions|sort(attribute='dateTransaction', reverse=true)|list %}
                            {% if derniers_transactions %}
                                {% for t in derniers_transactions[:3] %}
                                    <div class="transaction-item">
                                        <div class="transaction-info">
                                            <div class="transaction-titre">{{ t.titre }}</div>
                                            <div class="transaction-date">{{ t.dateTransaction.strftime('%d/%m/%Y') }}</div>
                                        </div>
                                        <div class="transaction-montant {{ 'positif' if t.montant >= 0 else 'negatif' }}">
                                            {{ '+' if t.montant >= 0 else '' }}{{ '%.2f'|format(t.montant) }} ‚Ç¨
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-transactions">Aucune transaction dans cette cat√©gorie</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state glass-card">
                <p>Aucune cat√©gorie pour l'instant.</p>
                <p>Ajoutez-en une ci-dessus !</p>
            </div>
        {% endif %}
    </div>

</main>
{% endblock %}

{% block scripts %}
<script>
    function toggleTransactions(btn, id) {
        const dropdown = document.getElementById(id);
        dropdown.classList.toggle('open');
        btn.classList.toggle('active');

        if (dropdown.classList.contains('open')) {
            btn.textContent = '‚ñ≤ Masquer';
        } else {
            btn.textContent = '‚ñº Voir';
        }
    }

    function toggleLimitInput() {
        const checkbox = document.getElementById('has_limit');
        const input = document.getElementById('limite_budget_input');
        
        if (checkbox.checked) {
            input.style.display = 'block';
            input.required = true;
        } else {
            input.style.display = 'none';
            input.required = false;
            input.value = '';
        }
    }
</script>
{% endblock %}
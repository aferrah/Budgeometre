<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budgeomètre - Analytics</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/budget-dashboard.css') }}">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <header>
            <h1>Budgeomètre</h1>
            <p class="subtitle">Votre tableau de bord financier</p>
        </header>

        <div class="period-selector">
            <button class="period-btn active" onclick="changePeriod('month')">Mois</button>
            <button class="period-btn" onclick="changePeriod('quarter')">Trimestre</button>
            <button class="period-btn" onclick="changePeriod('year')">Année</button>
        </div>

        <!-- ------------------ CARDS ------------------ -->
        <div class="stats-grid">

            <!-- Dépenses -->
            <div class="glass-card stat-card">
                <div class="stat-label">Dépenses (mois en cours)</div>
                <div class="stat-value">
                    {{ '%.2f'|format(total_depenses) }}€
                </div>
                <div class="stat-change down">
                    <span>vs mois dernier</span>
                </div>
            </div>

            <!-- Revenus -->
            <div class="glass-card stat-card">
                <div class="stat-label">Revenus (mois en cours)</div>
                <div class="stat-value">
                    {{ '%.2f'|format(total_revenus) }}€
                </div>
                <div class="stat-change up">
                    <span>vs mois dernier</span>
                </div>
            </div>

            <!-- Solde -->
            <div class="glass-card stat-card">
                <div class="stat-label">Solde</div>
                <div class="stat-value"
                     style="color: {{ '#22c55e' if solde >= 0 else '#ef4444' }};">
                    {{ '%.2f'|format(solde) }}€
                </div>
                <div class="stat-change {{ 'up' if solde >= 0 else 'down' }}">
                    <span>{{ 'Excédent' if solde >= 0 else 'Déficit' }}</span>
                </div>
            </div>

            <!-- Objectifs -->
            <div class="glass-card stat-card">
                <div class="stat-label">Objectifs</div>
                <div class="stat-value">
                    {{ objectifs_respectes }}/{{ nb_objectifs }}
                </div>
                <div class="stat-change" style="color: rgba(255,255,255,0.8);">
                    <span>{{ ratio_objectifs }}% respectés</span>
                </div>
            </div>

        </div>

        <!-- ------------------ GRAPHIQUES ------------------ -->
        <div class="charts-grid">
            <div class="glass-card chart-container">
                <h3 class="chart-title">Évolution 6 mois</h3>
                <canvas id="lineChart"></canvas>
            </div>

            <div class="glass-card chart-container">
                <h3 class="chart-title">Dépenses par catégorie</h3>
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <!-- ------------------ ALERTES (fixe pour l'instant) ------------------ -->
        <div class="alerts-container">

            <div class="alert danger">
                <div class="alert-content">
                    <h4>Dépenses élevées</h4>
                    <p>Une ou plusieurs catégories dépassent vos seuils.</p>
                    <div class="progress-bar">
                        <div class="progress-fill danger" style="width:100%;"></div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- ------------------ SCRIPT BACKEND → FRONT ------------------ -->
    <script>
        // Valeurs réelles envoyées par Flask
        const depensesParCategorieBackend = {{ depenses_par_categorie_dict | tojson }};

        // Catégories fixes + couleurs
        const categoriesRef = [
            { nom: 'Alimentation', color: '#10b981' },
            { nom: 'Transport', color: '#3b82f6' },
            { nom: 'Loisirs', color: '#f59e0b' },
            { nom: 'Logement', color: '#8b5cf6' },
            { nom: 'Santé', color: '#ec4899' },
            { nom: 'Vêtements', color: '#14b8a6' },
            { nom: 'Éducation', color: '#f97316' },
            { nom: 'Épargne', color: '#06b6d4' },
            { nom: 'Autres', color: '#64748b' }
        ];

        // Transformation pour le graphique
        const labels = Object.keys(depensesParCategorieBackend);
        const data = Object.values(depensesParCategorieBackend);

        const colors = labels.map(label => {
            const cat = categoriesRef.find(c => c.nom === label);
            return cat ? cat.color : '#64748b';
        });

        // ------------------ GRAPHIQUE BARRES ------------------
        function createBarChart() {
            const ctx = document.getElementById('barChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Dépenses',
                        data: data,
                        backgroundColor: colors,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ------------------ GRAPHIQUE LINES (fake pour l’instant) ------------------
        function createLineChart() {
            const ctx = document.getElementById('lineChart').getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Juin', 'Juillet', 'Août', 'Sept', 'Oct', 'Nov'],
                    datasets: [
                        {
                            label: 'Dépenses',
                            data: [2503, 2341, 3260, 3454, 2991, 3608],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Revenus',
                            data: [2500, 2500, 2500, 2700, 2500, 2700],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ------------------ Périodes ------------------
        function changePeriod(period) {
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            console.log("Période choisie :", period);
        }

        // ------------------ INIT ------------------
        window.addEventListener('load', () => {
            createLineChart();
            createBarChart();
        });

    </script>

</body>
</html>
